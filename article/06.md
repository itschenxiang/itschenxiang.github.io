# Hive 作为 ETL 的工具 - 示例
## 下载数据
```
wget http://microdata.worldbank.org/index.php/catalog/1788/download/28424/WLD_1998_FIP_v01_M_CSV.zip
unzip -q WLD_1998_FIP_v01_M_CSV.zip
```

## 上传数据到 hdfs
```
hdfs dfs -mkdir -p /user/biadmin/WorldBank
cd WLD_1998_FIP_v01_M_CSV
hdfs dfs -put ./*.csv /user/biadmin/WorldBank
```

## 建表

```
Create table IF NOT EXISTS WorldBank_Finance_Inequality.tbl_data_poverty
(
 country String,   
 year int,
 logagedependency double,
 countrycode String,
 loginitialheadcount double,
 loginitialpovertygap double,
 growthinheadcount double,
 growthinpovertygap double,
 timespan int,
 loginitialgini double,
 growthinmeanincome double,
 growthingdppercapita double,
 logprivatecredit double,
 logcommercialcentralbank double,
 inflation double,
 populationgrowth double,
 logtrade double,
 logschooling double						
)
ROW FORMAT DELIMITED FIELDS TERMINATED BY ','
;
```


```
Create table IF NOT EXISTS WorldBank_Finance_Inequality.tbl_data_panel
(
 countrycode String,
 year int,
 timeperiod int,
 logprivatecredit double,
 inflation double,
 logtrade double,
 logschooling double,
 growthingini double,
 growthgdppercapita double,
 loginitialgini double,
 span int,
 loginitialgdppercapita double,
 growthlowestincomeshare double,
 loginitiallowestincomeshare double				
)
ROW FORMAT DELIMITED FIELDS TERMINATED BY ','
;
```

```
Create table IF NOT EXISTS WorldBank_Finance_Inequality.tbl_8005
(
 countrycode String,
 country String,
 year int,
 loginitialgini double,
 growtheingini double,
 span int,
 logprivatecredit double,
 inflation double,
 logtrade double,
 logschooling double,
 logcommercialcentralbank double,
 loginitiallowestincomeshare double,
 growthinlowestincomeshare double						
)
ROW FORMAT DELIMITED FIELDS TERMINATED BY ','
;
```

```
Create table IF NOT EXISTS WorldBank_Finance_Inequality.tbl_6005
(
 countrycode String,
 year int,
 loginitialgini double,
 growthingini double,
 span int,
 loginitialgdppercapital double,
 growthgdppercapital double,
 privcreavg double,
 logprivatecredit double,
 inflation double,
 logtrade double,
 gr_ltrade double,
 gr_school double,
 logschooling double,
 logcommercialcentralbank double,
 loginitiallowestincomeshare double,
 growthinlowestincomeshare double						
)
ROW FORMAT DELIMITED FIELDS TERMINATED BY ','
;
```

## 更新表结构，忽略表头
```
alter table tbl_6005 set tblproperties('skip.header.line.count'='1');
alter table tbl_8005 set tblproperties('skip.header.line.count'='1');
alter table tbl_data_panel set tblproperties('skip.header.line.count'='1');
alter table tbl_data_poverty set tblproperties('skip.header.line.count'='1');
```

## 导入数据
```
LOAD DATA INPATH '/user/biadmin/WorldBank/Finance_inequality_and_the_poor_data_6005.csv' 
OVERWRITE INTO TABLE tbl_6005;
```
```
LOAD DATA INPATH '/user/biadmin/WorldBank/Finance_inequality_and_the_poor_data_8005.csv' 
OVERWRITE INTO TABLE tbl_8005;
```
```
LOAD DATA INPATH '/user/biadmin/WorldBank/Finance_inequality_and_the_poor_data_panel.csv' 
OVERWRITE INTO TABLE tbl_data_panel;
```
```
LOAD DATA INPATH '/user/biadmin/WorldBank/Finance_inequality_and_the_poor_data_poverty.csv' 
OVERWRITE INTO TABLE tbl_data_poverty;
```

## 建立聚合表
```
CREATE table master_tbl_Finance_Inequality AS
 
SELECT 
a.countrycode, 
b.country, 
a.year, 
c.timeperiod, 
a.loginitialgini, 
a.growthingini,
a.span, 
a.loginitialgdppercapital,

a.growthgdppercapital, 
a.privcreavg, 
a.logprivatecredit, 
a.inflation, 
a.logtrade, 
a.gr_ltrade, 
a.gr_school, 
a.logschooling,
a.logcommercialcentralbank, 
a.loginitiallowestincomeshare, a.growthinlowestincomeshare, 
d.logagedependency, 
d.loginitialheadcount,

d.loginitialpovertygap,
d.growthinheadcount,
d.growthinpovertygap,
d.growthinmeanincome,
d.populationgrowth

FROM WorldBank_Finance_inequality.tbl_6005 A 
LEFT OUTER JOIN

WorldBank_Finance_inequality.tbl_8005 B ON A.countrycode = B.countrycode 
RIGHT OUTER JOIN

WorldBank_Finance_inequality.tbl_data_panel C ON A.countrycode = C.countrycode 
LEFT OUTER JOIN

WorldBank_Finance_inequality.tbl_data_poverty D ON A.countrycode = D.countrycode
;
```
## 查询聚合表
```
select countrycode, country, 
CASE WHEN YEAR > 1990 then YEAR ELSE 0 END AS theYEAR, 
populationgrowth, growthinpovertygap
FROM master_tbl_finance_inequality;
```

## 参考链接
* [Use Hive as ETL or ELT tools](https://titanwolf.org/Network/Articles/Article?AID=b7ceb257-02b8-44f1-90cb-f99bca6b2818)
* [Hive表Load数据时过滤首行](https://blog.csdn.net/weixin_45666566/article/details/111462943)
